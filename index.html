<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDS ILO Chatbot</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; height: 100vh; margin: 0; }
        .chat-container { width: 100%; max-width: 800px; background: white; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 95vh; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        .chat-header { background-color: #2c3e50; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.2em; }
        
        .status-bar { background: #ecf0f1; padding: 10px 15px; font-size: 0.85em; color: #555; border-bottom: 1px solid #ddd; line-height: 1.4; display: flex; flex-wrap: wrap; gap: 10px; }
        .status-item strong { color: #2980b9; }

        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 10px; max-width: 80%; line-height: 1.5; font-size: 15px; word-wrap: break-word; }
        .bot-msg { background-color: #e8f6f3; align-self: flex-start; border-left: 4px solid #1abc9c; color: #333; }
        .user-msg { background-color: #d5f5e3; align-self: flex-end; color: #333; text-align: right; }
        
        .input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; background: #fff; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 15px; }
        button.send-btn { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        button.send-btn:hover { background-color: #2980b9; }

        .options-container { padding: 10px 20px; background: #f9f9f9; border-top: 1px solid #eee; max-height: 200px; overflow-y: auto; display: none; }
        .options-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .option-btn { background: white; border: 1px solid #ccc; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .option-btn:hover { background: #3498db; color: white; border-color: #3498db; }

        .ilo-card { border: 1px solid #eee; background: white; padding: 12px; margin-top: 8px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tag { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: bold; text-transform: uppercase; }
        .tag-cat { background: #e8f8f5; color: #1abc9c; }
        .tag-bloom { background: #fef9e7; color: #f1c40f; }
        .loading-dots { font-style: italic; color: #888; }

        .action-btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .action-btn { flex: 1; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 14px; }
        .btn-retry { background-color: #27ae60; } /* ç¶ è‰² */
        .btn-restart { background-color: #7f8c8d; } /* ç°è‰² */
        .btn-retry:hover { background-color: #2ecc71; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">èª²ç¨‹æ•™æ¡ˆåŠ©æ‰‹ (Chatbot)</div>
    
    <div class="status-bar" id="status-bar">
        <span>Topic: <strong id="s-topic">-</strong></span>
        <span>Desc: <strong id="s-desc">-</strong></span>
        <span>Subject: <strong id="s-subject">-</strong></span>
        <span>Grade: <strong id="s-grade">-</strong></span>
        <span>Level: <strong id="s-level">-</strong></span>
        <span>Verb: <strong id="s-verb">-</strong></span>
    </div>

    <div class="chat-messages" id="chat-messages"></div>

    <div class="options-container" id="options-container">
        <div style="font-size:0.9em;color:#777;margin-bottom:8px;">è«‹é¸æ“‡ï¼š</div>
        <div class="options-grid" id="options-grid"></div>
    </div>

    <div class="input-area" id="input-area">
        <input type="text" id="user-input" placeholder="Type here..." onkeypress="handleEnter(event)">
        <button class="send-btn" onclick="handleUserText()">Send</button>
    </div>
</div>

<script>
    let currentStep = 1; 
    let formData = {
        topic: "",
        description: "",
        subject: "",
        grade: "",
        bt_level: "",
        verb: ""
    };

    window.onload = function() {
        appendBotMessage("ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ•™æ¡ˆè¨­è¨ˆåŠ©æ‰‹ã€‚");
        setTimeout(() => appendBotMessage("Step 1: è«‹è¼¸å…¥**èª²ç¨‹åç¨± (Topic)** (ä¾‹å¦‚: The Water Cycle)"), 500);
    };

    function handleUserText() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        appendUserMessage(text);
        input.value = "";

        if (currentStep === 1) {
            formData.topic = text;
            updateStatus();
            currentStep = 2;
            appendBotMessage("Step 2: è«‹è¼¸å…¥**èª²ç¨‹æè¿° (Description)**ï¼Œæè¿°æ•™å­¸å…§å®¹æˆ–æ´»å‹•ã€‚");
        } 
        else if (currentStep === 2) {
            formData.description = text;
            updateStatus();
            currentStep = 3;
            appendBotMessage("Step 3: è«‹é¸æ“‡**ç§‘ç›® (Subject)**ã€‚");
            fetchAndShowOptions('get_subjects', 'subject');
        }
    }

    function handleOptionClick(value, field) {
        appendUserMessage(value);
        formData[field] = value;
        updateStatus();
        hideOptions();

        if (currentStep === 3) {
            currentStep = 4;
            appendBotMessage("Step 4: è«‹é¸æ“‡**å¹´ç´š (Grade)**ã€‚");
            fetchAndShowOptions('get_grade_levels', 'grade');
        } 
        else if (currentStep === 4) {
            currentStep = 5;
            appendBotMessage("Step 5: è«‹é¸æ“‡ **Bloom's Level** (èªçŸ¥å±¤æ¬¡)ã€‚");
            fetchAndShowOptions('ILO_get_bt_levels', 'bt_level');
        }
        else if (currentStep === 5) {
            currentStep = 6;
            appendBotMessage("Step 6: è«‹é¸æ“‡ä¸€å€‹**å‹•è© (Verb)**ã€‚");
            fetchAndShowOptions('ILO_get_bt_verbs', 'verb');
        }
        else if (currentStep === 6) {
            currentStep = 7;
            document.getElementById('input-area').style.display = 'none';
            appendBotMessage("è³‡è¨Šæ”¶é›†å®Œç•¢ï¼Œæ­£åœ¨ç”Ÿæˆ ILOs...");
            callGenerateAPI();
        }
    }

    function retryStep5() {
        formData.bt_level = "";
        formData.verb = "";
        updateStatus();

        currentStep = 5;

        document.getElementById('input-area').style.display = 'flex';
        
        appendBotMessage("æ²’å•é¡Œï¼è®“æˆ‘å€‘é‡å°åŒä¸€å€‹èª²é¡Œ (<strong>" + formData.topic + "</strong>) é‡æ–°è¨­å®šç›®æ¨™ã€‚");
        appendBotMessage("Step 5: è«‹å†æ¬¡é¸æ“‡ **Bloom's Level** (èªçŸ¥å±¤æ¬¡)ã€‚");
        
        fetchAndShowOptions('ILO_get_bt_levels', 'bt_level');
    }

    function callGenerateAPI() {
        const loadingId = 'loading-' + Date.now();
        const chatBox = document.getElementById('chat-messages');
        chatBox.innerHTML += `<div class="message bot-msg loading-dots" id="${loadingId}">AI æ­£åœ¨æ€è€ƒä¸­...</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        fetch('/api/generate_ilos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById(loadingId).remove();
            
            if (data.error) {
                appendBotMessage("éŒ¯èª¤: " + data.error);
                return;
            }

            let html = `ç‚ºæ‚¨ç”Ÿæˆé—œæ–¼ <b>${formData.topic}</b> çš„å­¸ç¿’ç›®æ¨™ï¼š<br>`;
            if (Array.isArray(data)) {
                data.forEach((item, index) => {
                    const safeStatement = item.statement.replace(new RegExp('^' + item.verb, "i"), "").trim();
                    html += `
                    <div class="ilo-card">
                        <strong>${index + 1}.</strong> 
                        <span class="tag tag-cat">${item.category}</span>
                        <span class="tag tag-bloom">${item.bt_level}</span>
                        <br>
                        <b>${item.verb}</b> ${safeStatement}
                    </div>`;
                });
            } else {
                html += JSON.stringify(data);
            }
            appendBotMessage(html);
            
            const actionBtns = `
                <div class="action-btn-group">
                    <button class="action-btn btn-retry" onclick="retryStep5()">ğŸ”„ å†é€ ä¸€å€‹ (åŒä¸€èª²é¡Œ)</button>
                    <button class="action-btn btn-restart" onclick="location.reload()">ğŸ  å…¨éƒ¨é‡æ–°é–‹å§‹</button>
                </div>
            `;
            document.getElementById('chat-messages').innerHTML += `<div class="message bot-msg" style="background:none; padding-left:0;">${actionBtns}</div>`;
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        })
        .catch(err => {
            document.getElementById(loadingId).remove();
            appendBotMessage("é€£ç·šéŒ¯èª¤: " + err);
        });
    }

    function fetchAndShowOptions(apiKey, fieldName) {
        document.getElementById('user-input').disabled = true;
        document.getElementById('user-input').placeholder = "è«‹å¾ä¸Šæ–¹é¸æ“‡...";

        fetch('/api/proxy?api=' + apiKey)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('options-container');
                const grid = document.getElementById('options-grid');
                grid.innerHTML = '';
                
                if (Array.isArray(data)) {
                    const limit = (fieldName === 'verb') ? 40 : data.length;
                    data.slice(0, limit).forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.innerText = item.name;
                        btn.onclick = () => handleOptionClick(item.name, fieldName);
                        grid.appendChild(btn);
                    });
                }
                container.style.display = 'block';
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
            })
            .catch(err => appendBotMessage("ç„¡æ³•è¼‰å…¥é¸é …: " + err));
    }

    function hideOptions() {
        document.getElementById('options-container').style.display = 'none';
        document.getElementById('user-input').disabled = false;
        document.getElementById('user-input').placeholder = "Type here...";
        document.getElementById('user-input').focus();
    }

    function appendBotMessage(html) {
        const div = document.createElement('div');
        div.className = 'message bot-msg';
        div.innerHTML = html;
        document.getElementById('chat-messages').appendChild(div);
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    function appendUserMessage(text) {
        const div = document.createElement('div');
        div.className = 'message user-msg';
        div.innerText = text;
        document.getElementById('chat-messages').appendChild(div);
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    function updateStatus() {
        document.getElementById('s-topic').innerText = formData.topic || '-';
        document.getElementById('s-desc').innerText = formData.description ? 'OK' : '-';
        document.getElementById('s-subject').innerText = formData.subject || '-';
        document.getElementById('s-grade').innerText = formData.grade || '-';
        document.getElementById('s-level').innerText = formData.bt_level || '-';
        document.getElementById('s-verb').innerText = formData.verb || '-';
    }

    function handleEnter(e) { if (e.key === 'Enter') handleUserText(); }
</script>

</body>
</html>